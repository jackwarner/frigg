service: frigg

provider:
  name: aws
  runtime: nodejs6.10
  stage: local
  environment:
    GITHUB_TOKEN: ${opt:githubToken}
    LOG_LEVEL:
      Fn::FindInMap: [ LogLevel, '${opt:stage, self:provider.stage}', level ]
  iamRoleStatements:
    - Effect: Allow
      Resource: '*'
      Action: '*'

functions:

  GitHubEventHandler:
    handler: github/webhook.handler
    events:
      - http:
          path: github
          method: post
          cors: true
    environment:
      CREATE_PIPELINE_TOPIC: { Ref: 'SNSTopicCreatepipeline${opt:stage, self:provider.stage}' }
      UPDATE_PIPELINE_TOPIC: { Ref: 'SNSTopicUpdatepipeline${opt:stage, self:provider.stage}' }
      # REMOVE_PIPELINE_TOPIC: { Ref: 'SNSTopicSavepipelinestatus${opt:stage, self:provider.stage}' }
      GITHUB_WEBHOOK_SECRET:
        Fn::Join:
          - '-'
          - - '${opt:stage, self:provider.stage}'
            - Ref: AWS::AccountId

  CreatePipeline:
    handler: pipelines/create.handler
    timeout: 300 # 5 minutes
    events:
      - sns: create-pipeline-${opt:stage, self:provider.stage}
    # environment:
    #   SAVE_PIPELINE_STATUS_TOPIC: { Ref: 'SNSTopicCreatepipeline${opt:stage, self:provider.stage}' }

  UpdatePipeline:
    handler: pipelines/update.handler
    events:
      - sns: update-pipeline-${opt:stage, self:provider.stage}
    # environment:
    #   SAVE_PIPELINE_STATUS_TOPIC: { Ref: 'SNSTopicCreatepipeline${opt:stage, self:provider.stage}' }

  RemovePipeline:
    handler: pipelines/remove.handler
    events:
      - sns: remove-pipeline-${opt:stage, self:provider.stage}
    # environment:
    #   SAVE_PIPELINE_STATUS_TOPIC: { Ref: 'SNSTopicCreatepipeline${opt:stage, self:provider.stage}' }

  # SavePipelineStatus:
  #   handler: pipelines/saveStatus.handler
  #   events:
  #     - sns: save-pipeline-status-${opt:stage, self:provider.stage}

resources:
  Description: Automated service for managing CodePipelines for repos & branches inside a GitHub organization

  Mappings:
    LogLevel:
      test:
        level: TRACE
      local:
        level: TRACE
      automation:
        level: INFO
      production:
        level: INFO
  
  Resources:
    # DynamoDB table for storing pipeline information - which exist, build status, etc.
